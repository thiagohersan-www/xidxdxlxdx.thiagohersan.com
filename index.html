<html>
  <head>
    <title>XidxdxLxdx</title>
    
    <meta name="description" content="Cidade Queer é Cidade Lida">
    <meta name="keywords" content="art, app, city, queer, cidade queer, são paulo">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="shortcut icon" href="/imgs/favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">

    <style>
      #map {
        height: 100%;
      }
      #glyph-svg {
        display: block;
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        z-index: 4;
        pointer-events: none;
      }
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #floating-panel {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 5;
        background-color: rgba(0,0,0,0);
      }
      .button {
        font-family: 'Roboto','sans-serif';
        text-align: center;
        background-color: #fff;
        border: 1px #ccc solid;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
      }
      .button:hover {
        background-color: #eee;
      }
      .button:active {
        background-color: #ddd;
      }
      .hidden {
        display: none;
      }
      #clear-icon {
        font-size: 2em;
        line-height: 1em;
        font-weight: bold;
      }
      #download-link {
        color: #000;
      }
      #download-link:visited {
        color: #000;
      }
    </style>

    <script>
      var map;
      var markers = [];
      var mPoints = [];
      var SP = {lat: -23.58010, lng: -46.62991};
      var DISTANCE_THRESHOLD = 10;
      var GLYPH_STYLE = "fill-opacity:0;stroke:#404040;stroke-width:6";
      var MARKER_ICON;

      function initMap() {
        MARKER_ICON = {
          path: google.maps.SymbolPath.CIRCLE,
          fillColor: '#404040',
          fillOpacity: 1,
          strokeOpacity: 0,
          scale: 6
        };

        map = new google.maps.Map(document.getElementById('map'), {
          center: SP,
          zoom: 12,
          styles: [
            {
              featureType: 'poi',
              stylers: [{visibility: 'off'}]
            },
            {
              featureType: 'transit',
              stylers: [{visibility: 'off'}]
            }
          ]
        });

        map.addListener('click', function(event) {
          var cPos = event.latLng;

          var marker = new google.maps.Marker({
            position: cPos,
            map: map,
            icon: MARKER_ICON
          });

          function deleteMarker(markerToDelete) {
            return function(event) {
              markerToDelete.setMap(null);
              for(var i=0; i<markers.length; i++) {
                if(markers[i].getMap() == null) {
                  markers.splice(i, 1);
                  return;
                }
              }
            };
          }

          marker.addListener('click', deleteMarker(marker));
          markers.push(marker);
        });
      }

      function drawEllipse(svgId, cx, cy, rx, ry) {
        var tEllipse = document.createElementNS("http://www.w3.org/2000/svg", "ellipse");
        tEllipse.setAttributeNS(null, "cx", cx);
        tEllipse.setAttributeNS(null, "cy", cy);
        tEllipse.setAttributeNS(null, "rx", rx);
        tEllipse.setAttributeNS(null, "ry", ry);
        tEllipse.setAttributeNS(null, "style", GLYPH_STYLE);
        document.getElementById(svgId).appendChild(tEllipse);
      }

      function drawLine(svgId, x1, y1, x2, y2) {
        var tLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
        tLine.setAttributeNS(null, "x1", x1);
        tLine.setAttributeNS(null, "y1", y1);
        tLine.setAttributeNS(null, "x2", x2);
        tLine.setAttributeNS(null, "y2", y2);
        tLine.setAttributeNS(null, "style", GLYPH_STYLE);
        document.getElementById(svgId).appendChild(tLine);
      }

      function drawBezier(svgId, x1, y1, x2, y2, x3, y3, x4, y4) {
        var tPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
        var d = "M"+x1+" "+y1+" C "+x2+" "+y2+", "+x3+" "+y3+", "+x4+" "+y4;
        tPath.setAttributeNS(null, "d", d);
        tPath.setAttributeNS(null, "style", GLYPH_STYLE);
        document.getElementById(svgId).appendChild(tPath);
      }

      function fromLatLngToPoint(markers, points) {
        var projection = map.getProjection();
        var bounds = map.getBounds();
        var topRight = projection.fromLatLngToPoint(bounds.getNorthEast());
        var bottomLeft = projection.fromLatLngToPoint(bounds.getSouthWest());
        var scale = Math.pow(2, map.getZoom());

        points.length = 0;
        for(var i=0; i<markers.length; i++) {
          var thisPoint = projection.fromLatLngToPoint(markers[i].getPosition());
          var xy = {};
          xy['x'] = Math.floor((thisPoint.x - bottomLeft.x) * scale);
          xy['y'] = Math.floor((thisPoint.y - topRight.y) * scale);
          points.push(xy);
        }
      }

      function drawGlyphs(points) {
        if(points.length < 1) return;

        var somePoints = [];
        for(var i=0; i<10; i++) {
          somePoints.push(points[Math.floor(points.length * Math.random())]);
        }

        var numberOfGlyphs = Math.floor(5 + 2 * Math.random());

        for(var i=0; i<numberOfGlyphs; i++) {
          var tPoints = [];
          for(var j=0; j<4; j++) {
            tPoints.push(somePoints[Math.floor(somePoints.length * Math.random())]);
          }

          var mR = Math.random();
          if (mR < 0.6) {
            drawBezier('glyph-svg',
                       tPoints[0].x, tPoints[0].y,
                       tPoints[1].x, tPoints[1].y,
                       tPoints[2].x, tPoints[2].y,
                       tPoints[3].x, tPoints[3].y);
          } else if (mR < 0.8) {
            drawLine('glyph-svg',
                     tPoints[0].x, tPoints[0].y,
                     tPoints[1].x, tPoints[1].y);
          } else {
            drawEllipse('glyph-svg',
                        tPoints[0].x, tPoints[0].y,
                        Math.abs(tPoints[0].x - tPoints[1].x)/2,
                        Math.abs(tPoints[0].y - tPoints[2].y)/2);
          }
        }

        // http://stackoverflow.com/questions/2483919/how-to-save-svg-canvas-to-local-filesystem
        var svg = '<svg version="1.1" xmlns="http://www.w3.org/2000/svg">';
        var b64 = btoa(svg+document.getElementById("glyph-svg").innerHTML+"</svg>");
        var href = "data:image/svg+xml;base64,\n"+b64;
        document.getElementById("download-link").setAttribute("href", href);
      }

      function clearGlyph() {
        document.getElementById("clear-button").style['display'] = 'none';
        document.getElementById("download-button").style['display'] = 'none';
        document.getElementById("draw-icon").setAttribute("class", "fa fa-pencil fa-2x");
        document.getElementById("glyph-svg").style['pointer-events'] = 'none';
        document.getElementById("glyph-svg").innerHTML = '';
        google.maps.event.clearListeners(map, 'bounds_changed');
      }

      function generateGlyph() {
        document.getElementById("clear-button").style['display'] = 'block';
        document.getElementById("download-button").style['display'] = 'block';
        document.getElementById("draw-icon").setAttribute("class", "fa fa-repeat fa-2x");
        document.getElementById("glyph-svg").style['pointer-events'] = 'auto';
        document.getElementById("glyph-svg").innerHTML = '';

        var originalBounds = map.getBounds();

        var bounds = new google.maps.LatLngBounds();
        for(var i=0; i<markers.length; i++) {
          bounds.extend(markers[i].getPosition());
        }

        google.maps.event.addListenerOnce(map, 'bounds_changed', function(event) {
          if(markers.length < 1) {
            this.setCenter(SP);
            this.setZoom(12);
          }

          if(this.getZoom() > 15) {
            this.setZoom(15);
          }
          fromLatLngToPoint(markers, mPoints);
          drawGlyphs(mPoints);
        });

        map.fitBounds(bounds);
        if(originalBounds.equals(map.getBounds())) {
          fromLatLngToPoint(markers, mPoints);
          drawGlyphs(mPoints);
        }
      }

    </script>
  </head>
  <body>
    <div id="floating-panel">
      <div id="draw-button" class="button" onclick="generateGlyph();">
        <i id="draw-icon" class="fa fa-pencil fa-2x" aria-hidden="true"></i>
      </div>
      <div id="clear-button" class="button hidden" onclick="clearGlyph();">
        <b id="clear-icon" aria-hidden="true">&#8709;</b>
      </div>
      <a target="_blank" id="download-link" href-lang="image/svg+xml" href="" download="glyph.svg" title="download">
        <div id="download-button" class="button hidden">
          <i id="download-icon" class="fa fa-download fa-2x" aria-hidden="true"></i>
        </div>
      </a>
    </div>
    <div id="map"></div>
    <svg id="glyph-svg" version="1.1" xmlns="http://www.w3.org/2000/svg"></svg>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD3l6PD1gs75rjnKmAn8mk6m47zcjHbpDU&callback=initMap" async defer></script>
  </body>
</html>
